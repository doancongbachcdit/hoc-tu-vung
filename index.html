<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocab SRS - H·ªçc Th√¥ng Minh</title>
    <meta name="theme-color" content="#4f46e5">
    <script src="dexie.js"></script>
    
    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; --card: #fff; --text: #334155; --success: #22c55e; --danger: #ef4444; --warning: #f59e0b; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 600px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        
        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #e2e8f0; padding: 4px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: 600; cursor: pointer; border-radius: 8px; color: #64748b; transition: 0.2s; }
        .tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .content { display: none; animation: fadeIn 0.3s; }
        .content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; } }

        input, select { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; font-size: 16px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: var(--text); }
        
        /* SRS Badge */
        .srs-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.9em; background: #eff6ff; padding: 10px; border-radius: 8px; color: var(--primary); }
        .due-badge { background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; font-weight: bold; }
        
        /* Quiz Styles */
        .word-display { font-size: 2.2rem; font-weight: 800; text-align: center; color: var(--primary); margin: 30px 0; min-height: 60px; }
        .grid-options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .opt-btn { padding: 18px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; cursor: pointer; font-weight: 500; }
        .opt-btn:hover { background: #f1f5f9; }
        .opt-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .opt-btn.wrong { background: var(--danger); color: white; border-color: var(--danger); opacity: 0.6; }

        .vocab-item { display: flex; justify-content: space-between; padding: 14px; border-bottom: 1px solid #f1f5f9; align-items: center; }
        .level-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('quiz')">üß† H·ªçc T·∫≠p</button>
        <button class="tab-btn" onclick="switchTab('data')">üìÇ D·ªØ Li·ªáu</button>
        <button class="tab-btn" onclick="switchTab('list')">üìö Danh S√°ch</button>
    </div>

    <div id="quiz" class="content active">
        <div class="card">
            <div class="srs-info">
                <span id="reviewStatus">ƒêang t·∫£i...</span>
                <select id="quizFilter" onchange="resetQuiz()" style="width:auto; padding:5px; margin:0; font-size:0.9em">
                    <option value="ALL">T·∫•t c·∫£</option>
                    <option value="EN">Ti·∫øng Anh</option>
                    <option value="CN">Ti·∫øng Trung</option>
                </select>
            </div>

            <div id="quizArea" style="display:none">
                <div class="word-display" id="qWord">---</div>
                
                <div class="grid-options" id="qOptions"></div>
                
                <div id="qMsg" style="text-align:center; height:25px; margin:15px 0; font-weight:bold"></div>
                
                <div style="display:flex; gap:10px">
                    <button class="btn btn-outline" id="btnPrev" onclick="prevQuestion()" disabled>‚¨ÖÔ∏è Xem l·∫°i</button>
                    <button class="btn btn-primary" id="btnNext" onclick="nextQuestion()">Ti·∫øp theo ‚û°Ô∏è</button>
                </div>
            </div>

            <div id="doneArea" style="text-align:center; padding:30px; display:none">
                <div style="font-size: 3rem;">üéâ</div>
                <h3>Tuy·ªát v·ªùi!</h3>
                <p>B·∫°n ƒë√£ ho√†n th√†nh b√†i √¥n t·∫≠p h√¥m nay.</p>
                <button class="btn btn-outline" onclick="forceReviewMode()">üí™ √în t·∫≠p ng·∫´u nhi√™n (Cram)</button>
            </div>

            <div id="emptyArea" style="text-align:center; padding:30px; display:none">
                <p>Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y th√™m t·ª´ v·ª±ng ƒë·ªÉ b·∫Øt ƒë·∫ßu!</p>
                <button class="btn btn-primary" onclick="switchTab('data')">Th√™m t·ª´ ngay</button>
            </div>
        </div>
    </div>

    <div id="data" class="content">
        <div class="card">
            <h3>‚ûï Th√™m T·ª´ M·ªõi</h3>
            <div style="display:flex; gap:10px">
                <input type="text" id="inpWord" placeholder="T·ª´ (VD: Cat)" style="flex:2">
                <select id="inpLang" style="flex:1"><option value="EN">Anh</option><option value="CN">Trung</option></select>
            </div>
            <input type="text" id="inpMeaning" placeholder="Nghƒ©a (VD: Con m√®o)">
            <button class="btn btn-primary" onclick="addWord()">L∆∞u T·ª´</button>
            <p id="addStatus" style="text-align:center; color:var(--success); margin:5px 0"></p>
        </div>

        <div class="card">
            <h3>üìÇ Qu·∫£n l√Ω D·ªØ li·ªáu</h3>
            <div style="display:flex; gap:10px; margin-bottom:10px">
                <button class="btn btn-outline" onclick="downloadSample()">üì• File m·∫´u</button>
                <button class="btn btn-warning" onclick="resetLevels()">üîÑ Reset Level h·ªçc</button>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <input type="file" id="csvFile" accept=".csv" style="margin-bottom:0">
                <button class="btn btn-success" onclick="importCSV()" style="width:auto">N·∫°p CSV</button>
            </div>
            <div style="display:flex; gap:10px">
                <button class="btn btn-outline" onclick="exportJSON()">‚¨áÔ∏è Backup</button>
                <div style="position:relative; width:100%">
                    <input type="file" id="jsonFile" accept=".json" style="position:absolute; opacity:0; width:100%; height:100%; cursor:pointer">
                    <button class="btn btn-outline" style="width:100%">‚ôªÔ∏è Restore</button>
                </div>
            </div>
        </div>
        <button class="btn btn-danger" onclick="clearDB()">üóëÔ∏è X√≥a to√†n b·ªô</button>
    </div>

    <div id="list" class="content">
        <div class="card">
            <input type="text" id="search" placeholder="üîç T√¨m ki·∫øm..." onkeyup="renderList()">
            <div id="listContainer" style="max-height:500px; overflow-y:auto"></div>
        </div>
    </div>

<script>
    // --- 1. CONFIG & DB ---
    // C·∫•u h√¨nh SRS: S·ªë ng√†y gi√£n c√°ch cho c√°c level 1, 2, 3...
    // Level 0: H·ªçc ngay. Level 1: 1 ng√†y. Level 2: 3 ng√†y...
    const SRS_INTERVALS = [0, 1, 3, 7, 14, 30, 90, 180]; 

    const db = new Dexie("VocabDB");
    
    // UPDATE VERSION 2: Th√™m 'level' v√† 'nextReview'
    db.version(1).stores({ words: "++id, w, m, l" });
    db.version(2).stores({ words: "++id, w, m, l, level, nextReview" })
      .upgrade(tx => {
          // Khi ng∆∞·ªùi d√πng c≈© n√¢ng c·∫•p, m·∫∑c ƒë·ªãnh set level = 0
          return tx.table("words").toCollection().modify(item => {
              item.level = 0;
              item.nextReview = 0;
          });
      });

    let cachedWords = [];
    let dueWords = []; // Danh s√°ch c√°c t·ª´ c·∫ßn √¥n ngay
    let quizHistory = [];
    let historyIndex = -1;
    let isCramMode = false; // Ch·∫ø ƒë·ªô h·ªçc nh·ªìi (khi ƒë√£ h·∫øt t·ª´ c·∫ßn √¥n)

    // --- 2. CORE FUNCTIONS ---

    async function initApp() {
        // Load to√†n b·ªô t·ª´ v√†o RAM
        cachedWords = await db.words.toArray();
        
        // Ki·ªÉm tra xem c√≥ t·ª´ n√†o ch∆∞a c√≥ level (do l·ªói c≈©) th√¨ fix ngay
        const needFix = cachedWords.filter(w => w.level === undefined);
        if(needFix.length > 0) {
            await db.words.toCollection().modify(w => {
                if(w.level === undefined) { w.level = 0; w.nextReview = 0; }
            });
            cachedWords = await db.words.toArray();
        }

        updateSRSStatus();
        document.getElementById('jsonFile').addEventListener('change', restoreJSON);
        
        if(document.getElementById('quiz').classList.contains('active')) nextQuestion();
    }

    // T√≠nh to√°n xem t·ª´ n√†o c·∫ßn h·ªçc
    function calculateDueWords() {
        const now = Date.now();
        const filter = document.getElementById('quizFilter').value;
        
        let pool = cachedWords;
        if(filter !== 'ALL') pool = pool.filter(w => w.l === filter);

        // L·ªçc ra c√°c t·ª´ c√≥ th·ªùi gian review <= hi·ªán t·∫°i
        return pool.filter(w => (w.nextReview || 0) <= now).sort((a,b) => a.nextReview - b.nextReview);
    }

    function updateSRSStatus() {
        const due = calculateDueWords();
        const total = cachedWords.length;
        const msg = due.length > 0 
            ? `C·∫ßn √¥n: <b class="due-badge">${due.length}</b> t·ª´` 
            : `<span style="color:var(--success)">ƒê√£ h·ªçc xong!</span>`;
        document.getElementById('reviewStatus').innerHTML = msg;
    }

    async function addWord() {
        const w = document.getElementById('inpWord').value.trim();
        const m = document.getElementById('inpMeaning').value.trim();
        const l = document.getElementById('inpLang').value;
        if(!w || !m) return alert("Thi·∫øu th√¥ng tin!");

        const newItem = { 
            w, m, l, 
            level: 0,           // M·ªõi tinh
            nextReview: 0       // H·ªçc ngay
        };

        const id = await db.words.add(newItem);
        cachedWords.unshift({ ...newItem, id });
        
        document.getElementById('inpWord').value = '';
        document.getElementById('inpMeaning').value = '';
        document.getElementById('addStatus').innerText = "ƒê√£ l∆∞u!";
        setTimeout(()=>document.getElementById('addStatus').innerText="", 2000);
        
        updateSRSStatus();
    }

    // --- 3. QUIZ LOGIC (SRS) ---

    function resetQuiz() {
        quizHistory = [];
        historyIndex = -1;
        isCramMode = false;
        nextQuestion();
    }

    function nextQuestion() {
        if(historyIndex < quizHistory.length - 1) {
            historyIndex++;
            renderQuestion(quizHistory[historyIndex]);
            return;
        }

        // 1. L·∫•y danh s√°ch c·∫ßn √¥n
        dueWords = calculateDueWords();
        updateSRSStatus();

        let questionItem;

        // 2. Logic ch·ªçn t·ª´
        if (dueWords.length > 0) {
            // ∆Øu ti√™n t·ª´ c·∫ßn √¥n nh·∫•t
            isCramMode = false;
            // L·∫•y ng·∫´u nhi√™n trong 10 t·ª´ ƒë·∫ßu ti√™n ƒë·ªÉ ƒë·ª° nh√†m ch√°n
            const topN = dueWords.slice(0, 10);
            questionItem = topN[Math.floor(Math.random() * topN.length)];
        } else {
            // H·∫øt t·ª´ c·∫ßn √¥n
            if (!isCramMode) {
                // N·∫øu ch∆∞a b·∫≠t ch·∫ø ƒë·ªô Cram -> Hi·ªán m√†n h√¨nh ch√∫c m·ª´ng
                document.getElementById('quizArea').style.display = 'none';
                document.getElementById('doneArea').style.display = 'block';
                document.getElementById('emptyArea').style.display = 'none';
                return;
            } else {
                // Ch·∫ø ƒë·ªô Cram: L·∫•y ng·∫´u nhi√™n t·ª´ b·∫•t k·ª≥ ƒë·ªÉ √¥n
                const filter = document.getElementById('quizFilter').value;
                let pool = (filter === 'ALL') ? cachedWords : cachedWords.filter(x => x.l === filter);
                if (pool.length < 4) return showEmpty();
                questionItem = pool[Math.floor(Math.random() * pool.length)];
            }
        }

        if(!questionItem) return showEmpty();

        // 3. T·∫°o ƒë√°p √°n sai (Distractors)
        const filter = document.getElementById('quizFilter').value;
        let pool = (filter === 'ALL') ? cachedWords : cachedWords.filter(x => x.l === filter);
        
        if (pool.length < 4) return showEmpty();

        const distractors = pool
            .filter(x => x.id !== questionItem.id)
            .sort(() => 0.5 - Math.random())
            .slice(0, 3);
        
        const options = [questionItem, ...distractors].sort(() => 0.5 - Math.random());

        // 4. Hi·ªÉn th·ªã
        const qData = { correct: questionItem, options };
        quizHistory.push(qData);
        historyIndex++;
        
        document.getElementById('doneArea').style.display = 'none';
        document.getElementById('quizArea').style.display = 'block';
        document.getElementById('emptyArea').style.display = 'none';
        
        renderQuestion(qData);
    }

    function renderQuestion(q) {
        document.getElementById('qWord').innerText = q.correct.w;
        const grid = document.getElementById('qOptions');
        grid.innerHTML = '';
        document.getElementById('qMsg').innerText = '';
        
        // Hi·ªÉn th·ªã n√∫t
        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt.m;
            btn.onclick = () => handleAnswer(btn, opt, q.correct);
            grid.appendChild(btn);
        });

        document.getElementById('btnPrev').disabled = (historyIndex <= 0);
        // ·∫®n n√∫t Next cho ƒë·∫øn khi ch·ªçn ƒë√°p √°n (ƒë·ªÉ b·∫Øt bu·ªôc ng∆∞·ªùi d√πng suy nghƒ©)
        document.getElementById('btnNext').style.visibility = 'hidden'; 
    }

    // X·ª≠ l√Ω khi ch·ªçn ƒë√°p √°n (Tr√°i tim c·ªßa SRS)
    async function handleAnswer(btn, selected, correct) {
        // Disable buttons
        document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
        document.getElementById('btnNext').style.visibility = 'visible';

        const isCorrect = (selected.id === correct.id);
        
        if (isCorrect) {
            btn.classList.add('correct');
            document.getElementById('qMsg').innerHTML = "<span style='color:var(--success)'>Ch√≠nh x√°c! üéâ</span>";
            
            // LOGIC SRS: TƒÇNG C·∫§P
            if (!isCramMode) { // Ch·ªâ t√≠nh ƒëi·ªÉm khi h·ªçc ch√≠nh th·ª©c
                const currentLevel = correct.level || 0;
                const newLevel = currentLevel + 1;
                const daysToAdd = SRS_INTERVALS[newLevel] || 180; // M·∫∑c ƒë·ªãnh max 180 ng√†y
                const nextDate = Date.now() + (daysToAdd * 24 * 60 * 60 * 1000);
                
                await updateWordSRS(correct.id, newLevel, nextDate);
                
                // Feedback nh·ªè
                const msg = daysToAdd < 1 ? "√în l·∫°i ng√†y mai" : `√în l·∫°i sau ${daysToAdd} ng√†y`;
                document.getElementById('qMsg').innerHTML += ` <small style="color:#666">(${msg})</small>`;
            }

        } else {
            btn.classList.add('wrong');
            // Hi·ªán ƒë√°p √°n ƒë√∫ng
            document.querySelectorAll('.opt-btn').forEach(b => {
                if(b.innerText === correct.m) b.classList.add('correct');
            });
            document.getElementById('qMsg').innerHTML = "<span style='color:var(--danger)'>Qu√™n r·ªìi sao? üòÖ</span>";

            // LOGIC SRS: RESET V·ªÄ 0
            if (!isCramMode) {
                await updateWordSRS(correct.id, 0, 0); // Reset level, nextReview = 0 (b·∫Øt h·ªçc l·∫°i ngay)
                document.getElementById('qMsg').innerHTML += ` <small style="color:#666">(H·ªçc l·∫°i t·ª´ ƒë·∫ßu)</small>`;
            }
        }
    }

    async function updateWordSRS(id, newLevel, newNextReview) {
        // 1. Update DB
        await db.words.update(id, { level: newLevel, nextReview: newNextReview });
        
        // 2. Update RAM (ƒë·ªÉ UI c·∫≠p nh·∫≠t ngay m√† kh√¥ng c·∫ßn reload)
        const wordInRam = cachedWords.find(w => w.id === id);
        if (wordInRam) {
            wordInRam.level = newLevel;
            wordInRam.nextReview = newNextReview;
        }
        
        // 3. Update Badge
        updateSRSStatus();
    }

    function forceReviewMode() {
        isCramMode = true;
        nextQuestion();
    }

    function showEmpty() {
        document.getElementById('quizArea').style.display = 'none';
        document.getElementById('emptyArea').style.display = 'block';
    }

    // --- 4. LIST & UTILS ---

    function renderList() {
        const container = document.getElementById('listContainer');
        const search = document.getElementById('search').value.toLowerCase();
        container.innerHTML = '';
        
        // Hi·ªÉn th·ªã th·ªëng k√™ nh·ªè trong list
        let count = 0;
        for(const item of cachedWords) {
            if(count > 50 && !search) break;
            if(item.w.toLowerCase().includes(search) || item.m.toLowerCase().includes(search)) {
                
                // M√†u s·∫Øc ch·∫•m level
                const lvl = item.level || 0;
                let color = '#ccc'; // Lv0
                if(lvl > 0) color = '#ef4444'; // Lv1-2
                if(lvl > 2) color = '#f59e0b'; // Lv3-4
                if(lvl > 4) color = '#22c55e'; // Lv5+

                // Ng√†y review
                const due = item.nextReview || 0;
                const isDue = due <= Date.now();
                const dateStr = due === 0 ? "M·ªõi" : new Date(due).toLocaleDateString('vi-VN', {day:'numeric', month:'numeric'});

                const div = document.createElement('div');
                div.className = 'vocab-item';
                div.innerHTML = `
                    <div style="flex:1">
                        <div>
                            <span class="level-dot" style="background:${color}" title="Level ${lvl}"></span>
                            <span class="badge ${item.l}">${item.l}</span> 
                            <b>${item.w}</b>
                        </div>
                        <div style="font-size:0.9em; color:#64748b; margin-top:2px">
                            ${item.m} 
                            <span style="float:right; font-size:0.8em; color:${isDue?'red':'green'}">
                                ${isDue ? '‚ö° C·∫ßn √¥n' : 'üìÖ ' + dateStr}
                            </span>
                        </div>
                    </div>
                    <button onclick="deleteWord(${item.id})" style="border:none;background:none;color:#999;cursor:pointer;margin-left:10px">‚úñ</button>
                `;
                container.appendChild(div);
                count++;
            }
        }
    }

    async function resetLevels() {
        if(confirm("B·∫°n mu·ªën reset t·∫•t c·∫£ t·ª´ v·ª±ng v·ªÅ Level 0 (H·ªçc l·∫°i t·ª´ ƒë·∫ßu)?")) {
            await db.words.toCollection().modify({ level: 0, nextReview: 0 });
            cachedWords = await db.words.toArray();
            alert("ƒê√£ reset!");
            updateSRSStatus();
            renderList();
        }
    }

    function importCSV() {
        const file = document.getElementById('csvFile').files[0];
        if(!file) return alert("Ch∆∞a ch·ªçn file!");
        const reader = new FileReader();
        reader.onload = async (e) => {
            const lines = e.target.result.split(/\r\n|\n/);
            let newItems = [];
            lines.forEach(line => {
                const p = line.split(',');
                if(p.length >= 2 && !p[0].toLowerCase().includes('tuvung')) {
                    const w = p[0].trim(), m = p[1].trim(), l = p[2]?.trim().toUpperCase() || 'EN';
                    if(w && m) newItems.push({ w, m, l, level: 0, nextReview: 0 });
                }
            });
            if(newItems.length > 0) {
                await db.words.bulkAdd(newItems);
                cachedWords = await db.words.toArray();
                alert(`Th√™m ${newItems.length} t·ª´!`);
                updateSRSStatus();
            }
        };
        reader.readAsText(file);
    }

    // C√°c h√†m kh√°c gi·ªØ nguy√™n (Export, Delete, Tab...)
    async function deleteWord(id) {
        if(confirm("X√≥a?")) { await db.words.delete(id); cachedWords = cachedWords.filter(x=>x.id!==id); renderList(); updateSRSStatus(); }
    }
    async function clearDB() { if(confirm("X√≥a h·∫øt?")) { await db.words.clear(); cachedWords=[]; location.reload(); } }
    function downloadSample() { /* Gi·ªØ nguy√™n code c≈© */ 
        const c = "\uFEFFTuVung,Nghia,NgonNgu(EN/CN)\nHello,Xin ch√†o,EN"; 
        const b = new Blob([c],{type:'text/csv;charset=utf-8;'}); 
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download="Mau.csv"; a.click();
    }
    async function exportJSON() {
        const d = await db.words.toArray();
        const b = new Blob([JSON.stringify(d)],{type:"application/json"});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`Backup_${Date.now()}.json`; a.click();
    }
    function restoreJSON(e) {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader(); r.onload=async(ev)=>{
            try { const d = JSON.parse(ev.target.result); if(Array.isArray(d)) {
                await db.words.clear(); await db.words.bulkAdd(d); location.reload();
            }} catch(err){alert("L·ªói file");}
        }; r.readAsText(f);
    }
    function switchTab(id) {
        document.querySelectorAll('.content').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelector(`button[onclick="switchTab('${id}')"]`).classList.add('active');
        if(id==='list') renderList();
    }

    initApp();
</script>
</body>
</html>